#!/usr/bin/env ruby

require 'bundler/setup'
require 'dome'

opts = Trollop.options do
  version Dome::VERSION
  banner <<-EOS
Dome wraps the Terraform API and performs useful stuff.

Usage:
       dome [command]
where [commands] are:
EOS

  opt :plan, 'Creates a Terraform plan'
  opt :apply, 'Applies a Terraform plan'
  opt :plan_destroy, 'Creates a destructive Terraform plan'
  opt :state, 'Synchronises the Terraform state'
end

# TODO: hopefully we can flip this logic to DRY it up
if opts[:plan]
  @dome = Dome::Terraform.new
  @dome.validate_environment
  @dome.plan
elsif opts[:apply]
  @dome = Dome::Terraform.new
  @dome.validate_environment
  @dome.apply
elsif opts[:plan_destroy]
  @dome = Dome::Terraform.new
  @dome.validate_environment
  @dome.plan_destroy
elsif opts[:state]
  @dome = Dome::Terraform.new
  @dome.validate_environment
  @dome.state.s3_state
else
  Trollop.educate
end
